# 规约文档 (Spec)

---
name: researchflash-spec
description: ResearchFlash 灵感速记本完整规约
---

> 本规约基于 real.md（现实约束）与 cog.md（认知模型）生成，服务于科研人员的"放心遗忘"场景。

---

# 一、产品需求 (PRD)

<spec>
<section name="产品定位">

**产品名称**：ResearchFlash（研究灵感速记本）

**核心主张**：不是笔记软件，而是一个允许你"放心遗忘"的中转站。

**认知机制**：Capture (瞬间捕捉) -> Sleep (潜伏孵化) -> Resurface (灵感重现)

</section>

<section name="可供性目录">

拒绝功能列表，定义智能体（人类/AI）的感知-行动耦合：

**P级（主要可供性）- MVP必备**
| 可供性 | 感知线索 | 行动空间 | 约束引用 |
|--------|----------|----------|----------|
| 瞬间捕捉 | 首屏输入框直接可见 | 输入文字 → 一键保存 | @real: 首屏无阻断 |
| 字数约束 | 实时字数显示 (0/280) | 强制精简，避免完美主义 | @real: 280字限制 |
| 离线写入 | 无网络提示但不阻断输入 | 本地暂存 → 自动同步 | @real: 离线支持 |

**S级（次要可供性）- 第二迭代**
| 可供性 | 感知线索 | 行动空间 |
|--------|----------|----------|
| 灵感重现 | 周日晚8点推送通知 | 查看本周灵感 → 归档/删除 |
| 状态感知 | 灵感卡片颜色/标签 | 识别孵化中/待回顾/已归档 |

**L级（潜在可供性）- 未来探索**
| 可供性 | 感知线索 | 行动空间 |
|--------|----------|----------|
| 灵感关联 | AI识别相似灵感 | 查看关联 → 合并/串联 |
| 导出归档 | 导出按钮 | 批量导出为Markdown |

</section>

<section name="最小可供故事 (MAS)">

**核心场景**：科研人员在阅读论文时突然冒出一个想法，需要在3秒内完成捕捉，然后安心继续阅读。

**MAS验收标准**：
1. 打开App → 0秒看到输入框（无任何中间页）
2. 输入灵感 → 实时看到字数（0/280）
3. 点击保存 → 立即反馈成功（无论有无网络）
4. 关闭App → 灵感已安全存储

</section>
</spec>

---

# 二、用户故事 (User Story)

<spec>
<section name="故事分类原则">

按认知负荷与情绪价值分为三类：
- **光明故事 (Light)** 🌟：多巴胺驱动，用户获得正向反馈
- **黑暗故事 (Dark)** 🌑：注意力守护，异常处理与边界防护
- **灰色故事 (Grey)** 🌫️：认知负荷管理，日常维护与状态流转

**黄金比例**：早期迭代 Light:Dark:Grey = 5:2:1

</section>

<section name="复杂故事 (CS) 拆解">

## CS-001: 灵感捕捉流程

### 光明故事 🌟

**MS-001**: 零阻断捕捉
```
作为 科研人员
我想要 打开App立即看到输入框
以便于 在灵感消逝前完成捕捉
验收标准：首屏加载 < 1秒，输入框自动聚焦
```

**MS-002**: 字数实时反馈
```
作为 科研人员
我想要 输入时看到剩余字数
以便于 控制灵感粒度，避免写成长文
验收标准：字数显示实时更新，超限时变红
```

**MS-003**: 保存即安心
```
作为 科研人员
我想要 点击保存后立即得到确认
以便于 安心返回原来的工作
验收标准：保存后显示成功动画 < 300ms
```

### 黑暗故事 🌑

**MS-004**: 离线兜底
```
作为 在地铁/实验室的科研人员
我想要 无网络时也能保存灵感
以便于 不因环境限制丢失想法
验收标准：离线保存成功，网络恢复后自动同步，无需用户干预
```

**MS-005**: 超限保护
```
作为 容易写多的用户
我想要 超过280字时被明确阻止
以便于 强制自己精简表达
验收标准：超限后保存按钮禁用，显示"请精简至280字内"
```

### 灰色故事 🌫️

**MS-006**: 状态自动流转
```
作为 系统
我需要 在灵感创建7天后自动标记为"待回顾"
以便于 触发周日推送机制
验收标准：状态流转在后台静默完成，无需用户操作
```

---

## CS-002: 灵感重现流程

### 光明故事 🌟

**MS-007**: 周日推送
```
作为 科研人员
我想要 每周日晚8点收到本周灵感回顾
以便于 定期重温被遗忘的想法
验收标准：准时推送，包含本周所有"待回顾"状态灵感
```

**MS-008**: 快速归档
```
作为 科研人员
我想要 在回顾时一键归档灵感
以便于 快速处理已无价值的想法
验收标准：滑动归档，操作 < 1秒
```

### 黑暗故事 🌑

**MS-009**: 推送失败重试
```
作为 系统
我需要 在推送失败时自动重试
以便于 确保用户不会错过回顾
验收标准：失败后30分钟重试，最多3次
```

</section>
</spec>

---

# 三、系统架构 (Sys)

<spec>
<section name="技术栈锁定">

| 层级 | 技术选型 | 理由 |
|------|----------|------|
| 框架 | Next.js 15 (App Router) | 目录即路由，Server Components优先 |
| 语言 | TypeScript | 类型安全，AI友好 |
| 样式 | Tailwind CSS + Shadcn/ui | 原子化CSS，组件复用 |
| 运行时 | Bun | 替代npm，更快的包管理与执行 |
| ORM | Drizzle ORM | 类型安全，轻量级 |
| 认证 | Better Auth | 简化认证流程（MVP阶段可选） |
| AI | Vercel AI SDK | 流式响应，边缘部署友好 |
| 数据库 | SQLite (本地) / Turso (云端) | 离线优先架构 |

</section>

<section name="目录结构">

```
src/
├── app/                    # Next.js App Router
│   ├── page.tsx           # 首页（输入框直出）
│   ├── review/
│   │   └── page.tsx       # 灵感回顾页
│   ├── archive/
│   │   └── page.tsx       # 归档列表页
│   └── api/
│       ├── flash/
│       │   └── route.ts   # 灵感CRUD
│       └── sync/
│           └── route.ts   # 离线同步
├── components/
│   ├── FlashInput.tsx     # 核心输入组件
│   ├── FlashCard.tsx      # 灵感卡片
│   └── CharCounter.tsx    # 字数计数器
├── lib/
│   ├── db.ts              # Drizzle数据库配置
│   ├── offline.ts         # 离线存储逻辑
│   └── scheduler.ts       # 推送调度器
├── services/
│   └── flash.service.ts   # 灵感业务逻辑
└── types/
    └── flash.ts           # 类型定义
```

</section>

<section name="数据模型">

```typescript
// @source: .42cog/cog/cog.md

// 灵感实体 - 对应 <flash>
interface Flash {
  id: string;              // 时间戳编码: YYYYMMDDHHmm
  content: string;         // 内容，max 280字符
  status: FlashStatus;     // 状态枚举
  createdAt: Date;         // 创建时间
  syncedAt: Date | null;   // 同步时间（离线场景）
}

// 状态枚举 - 对应 <flash> 分类
enum FlashStatus {
  INCUBATING = 'incubating',  // 孵化中（7天内）
  SURFACED = 'surfaced',      // 待回顾（已推送）
  ARCHIVED = 'archived'       // 已归档
}

// 用户实体 - 对应 <user>
interface User {
  deviceId: string;        // 设备UUID
  createdAt: Date;
}
```

</section>

<section name="关键约束实现">

| 现实约束 | 技术实现 |
|----------|----------|
| 首屏无阻断 | `page.tsx` 直接渲染 `<FlashInput />`，无中间路由 |
| 280字限制 | 前端实时校验 + 后端二次校验，超限返回400 |
| 周日晚8点推送 | Vercel Cron Jobs 或 本地 Web Push API |
| 离线写入 | IndexedDB 本地存储 + Service Worker 后台同步 |

</section>

<section name="离线优先架构">

```
[用户输入]
    ↓
[IndexedDB 本地存储] ← 立即成功反馈
    ↓
[Service Worker 监听网络]
    ↓
[网络恢复] → [Background Sync API] → [服务端同步]
    ↓
[更新 syncedAt 字段]
```

</section>
</spec>

---

# 四、验收标准清单

<spec>
<section name="MVP验收">

| 编号 | 验收项 | 通过标准 |
|------|--------|----------|
| AC-001 | 首屏加载 | 冷启动 < 2秒，输入框可见 |
| AC-002 | 零阻断 | 无登录、引导、弹窗 |
| AC-003 | 字数限制 | 超280字无法保存 |
| AC-004 | 离线保存 | 断网状态下保存成功 |
| AC-005 | 自动同步 | 网络恢复后10秒内同步完成 |
| AC-006 | 状态流转 | 7天后自动变为"待回顾" |
| AC-007 | 周日推送 | 准时推送本周灵感列表 |

</section>
</spec>

---

# 五、约束引用索引

<spec>
<section name="Real约束追溯">

本规约引用的现实约束：

| 约束ID | 约束内容 | 规约引用位置 |
|--------|----------|--------------|
| R-001 | 首屏直接展示输入框 | PRD可供性目录、Sys关键约束实现 |
| R-002 | 单条灵感280字限制 | PRD可供性目录、MS-005 |
| R-003 | 每周日晚8点推送 | MS-007、Sys关键约束实现 |
| R-004 | 离线写入自动同步 | MS-004、Sys离线优先架构 |

</section>

<section name="Cog模型追溯">

本规约引用的认知模型：

| 实体 | 规约体现 |
|------|----------|
| flash | 数据模型 Flash 接口、状态枚举 |
| user | 数据模型 User 接口（设备UUID） |
| user-flash 关系 | 一对多，通过 deviceId 关联 |

</section>
</spec>
